<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تأكيد السحب</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fff;
      height: 100%;
      color: white;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100%;
    }

    .confirmation-box {
  background-color: rgba(255, 255, 255, 0.15);
  border-radius: 20px;
  color: black;
  padding: 20px;
  width: 90%;
  max-width: 90%;
  height: 80%;
  overflow-y: auto;
  box-shadow: 0 0 20px rgba(0,0,0,0.3);
  direction: rtl;        /* ضروري لعرض النصوص من اليمين */
  text-align: right;     /* محاذاة النص لليمين */
  overflow-y: auto;
}

/* تأكد أن كل النصوص والفقرات ترث نفس الاتجاه */
.confirmation-box * {
  direction: rtl;
  text-align: right;
}

    .confirmation-box h2 {
      margin-bottom: 15px;
    }

    .info {
      text-align: right;
      margin-top: 20px;
      font-size: 24px;
      color: #000;
    }

    .info p {
      margin: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
      padding-bottom: 5px;
    }

    .status {
      font-weight: bold;
      color: #000;
    }
  </style>
</head>
<body>

  <div class="confirmation-box">
    <h2 style="text-align: center;font-size:60px;"> تم إرسال طلب السحب</h2>
<p id="1" style="text-align: center;font-size:30px;">سيتم تحويل المبلغ بعد مراجعة الطلب من خادم  SwapIO</p>


<div style="margin-top: 5%;font-size:14px;">
    
    
  
   
  <!-- ✅ الحالة العامة -->
  <p style="font-size: 25px; font-weight: bold; margin: 0;">
  <span style="color: black;">الحالة:</span>
  <span id="2" style="color: #ffc107;">قيد المراجعة</span>
  <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
</p>
  <p><strong>المبلغ:</strong> <span id="amountText"></span> USD</p>
   <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
  <p><strong>طريقة السحب:</strong> <span id="methodText"></span></p>
   <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
  <p><strong>المعرف :</strong> <span id="accountText"></span></p>
   <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
  <p><strong>السحب إلى :</strong> <span id="withdrawEmail"></span></p>
  <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
  
      <!--كود البنك-->
    <div id="bankDetails" style="margin-top: 30px;"></div>

  
  <!-- ✅ رقم تعريفي للعملية -->
  <p style="margin-top: 0px; font-size: 14px;"><strong>رمز العملية:</strong> <span id="transactionId"></span></p>
   <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">

  <!-- ✅ تاريخ ووقت الطلب -->
  <p style="font-size: 14px;"><strong>تاريخ الطلب:</strong> <span id="requestDate"></span></p>
  <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
   
  </div>
  <p id="3" style="text-align: center;margin-top:10%;font-size:24px;font-weight:700;">تمت جدولة عملية السحب قد تستغرق العملية حوالى 1إلى2 ساعة وسيتم إرسال إشعار إليك عند الإنتهاء </p>
  


<div id="bankDetails" style="margin-top: 20px;"></div>

<div style="display: flex; justify-content: center; align-items: center;">
  <a href="#" onclick="history.back(); return false;"
     style="display: inline-block;font-size:28px; line-height: 3vh; width: 11vh; height: 3vh; padding: 12px 28px; background-color: #000; color: white; font-size: 16px; font-weight: bold; border-radius: 15px; text-decoration: none; text-align: center; transition: opacity 0.3s ease;">
    العودة
  </a>
</div>

<footer style="
  text-align: center;
  font-size: 20px;
  color: #888;
  padding: 10px 0;
  position: fixed;
  bottom: 1.5%;
  width: 96%;
  background-color: transparent;">
  جميع الحقوق محفوظة © 2025
</footer>

  </div>
  
  
  
          <!-- javascript -->

  <script>
if (localStorage.getItem("isLoggedIn") !== "true") {
    window.location.href = "index.html"; // يفتح صفحة تسجيل الدخول
}
  </script>
  
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
    // إعداد Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBhOhK3yCv4p-dhfXYx-w1aRB19a-VpRKY",
        authDomain: "swapio-30675.firebaseapp.com",
        projectId: "swapio-30675",
        storageBucket: "swapio-30675.appspot.com",
        messagingSenderId: "936588847751",
        appId: "1:936588847751:web:81aa27a8a12fc6d6a06622",
        measurementId: "G-L4RH076S6H",
        databaseURL: "https://swapio-30675-default-rtdb.firebaseio.com",// ← أضف هذا السطر!

    };

    // تفعيل Firebase
    firebase.initializeApp(firebaseConfig);
</script>

  <script>
(function(){
  const adminUid = "06Oe7rQjaIesgHuao3DaMdT0MzH3"; // غَيّرها
  const POLL_INTERVAL = 200;
  const MAX_WAIT_MS = 5000;

  const beforeUnloadHandler = (event) => {
    event.preventDefault();
    event.returnValue = "⏳ يرجى الانتظار، يتم إرسال البيانات الآن...";
  };

  function showLoading() {
    if (document.getElementById('__sendWithdraw_loading')) return;
    const el = document.createElement('div');
    el.id = '__sendWithdraw_loading';
    el.style = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:99999;color:#fff;font-size:18px;';
    el.innerHTML = '<div style="padding:18px 24px;border-radius:8px;background:rgba(0,0,0,0.6);">جاري إرسال طلب السحب... ⏳</div>';
    document.body.appendChild(el);
  }
  function hideLoading() {
    const el = document.getElementById('__sendWithdraw_loading');
    if (el) el.remove();
  }

  function waitForFirebase() {
    return new Promise((resolve, reject) => {
      let waited = 0;
      const iv = setInterval(() => {
        const hasDb = typeof window.db !== 'undefined';
        const hasFuncs = (window.firebaseDB && typeof window.firebaseDB.ref === 'function' && typeof window.firebaseDB.push === 'function' && typeof window.firebaseDB.set === 'function')
                          || (typeof ref === 'function' && typeof push === 'function' && typeof set === 'function');
        if (hasDb && hasFuncs) {
          clearInterval(iv);
          resolve();
          return;
        }
        waited += POLL_INTERVAL;
        if (waited >= MAX_WAIT_MS) {
          clearInterval(iv);
          reject(new Error('Firebase لم يكن جاهزاً خلال الفترة المحددة.'));
        }
      }, POLL_INTERVAL);
    });
  }

  window.addEventListener('load', async function () {
    // --- تحقق قيمة with في localStorage أولاً ---
    const withFlag = localStorage.getItem('with'); // 'true' أو 'false' أو null
    if (withFlag === 'true') {
      console.log("تم إرسال بيانات السحب مسبقاً (localStorage.with === 'true') — لن يُرسل مرة أخرى.");
      return; // لا ينفذ أي شيء لأن with = true
    }
    // إذا لم تكن 'true' فنكمل التنفيذ (كأن القيمة false أو غير موجودة)

    // الآن نمنع المغادرة ونظهر الـ loading لأننا سنبدأ الإرسال
    window.addEventListener('beforeunload', beforeUnloadHandler);
    showLoading();

    try {
      await waitForFirebase();
    } catch (err) {
      hideLoading();
      window.removeEventListener('beforeunload', beforeUnloadHandler);
      console.error(err);
      alert('Firebase لم يتم تهيئته بعد. تأكد أن سكربت التهيئة يعمل وأنه يعرّف window.db و window.firebaseDB (ref/push/set).');
      return;
    }

    const dbInstance = window.db;
    const _ref  = (window.firebaseDB && window.firebaseDB.ref) || (typeof ref === 'function' && ref);
    const _push = (window.firebaseDB && window.firebaseDB.push) || (typeof push === 'function' && push);
    const _set  = (window.firebaseDB && window.firebaseDB.set) || (typeof set === 'function' && set);

    if (!dbInstance || !_ref || !_push || !_set) {
      hideLoading();
      window.removeEventListener('beforeunload', beforeUnloadHandler);
      console.error('الوظائف اللازمة غير متاحة:', { dbInstance, _ref, _push, _set });
      alert('دوال Realtime Database غير متاحة. ضع ref/push/set على window.firebaseDB في سكربت التهيئة.');
      return;
    }

    // جلب البيانات
    const amount        = localStorage.getItem("withdrawAmount");
    const account       = localStorage.getItem("withdrawAccount");
    const method        = localStorage.getItem("withdrawMethod");
    const email         = localStorage.getItem("withdrawEmail");
    const bankNameHolder= localStorage.getItem("bankNameHolder");
    const bankIBAN      = localStorage.getItem("bankIBAN");
    const bankName      = localStorage.getItem("bankName");
    const bankSwift     = localStorage.getItem("bankSwift");
    // تاريخ مقروء
    const now = new Date().toLocaleString("en-GB", { hour12: false }).replace(',', '');

    if (!amount || !method) {
      hideLoading();
      window.removeEventListener('beforeunload', beforeUnloadHandler);
      console.warn('بعض القيم مفقودة في localStorage:', { amount, method });
      alert('بعض بيانات السحب مفقودة. تأكد أن localStorage يحوي withdrawAmount و withdrawMethod.');
      return;
    }

    try {
      // تحضير الـ payload الأساسي
      const payload = {
        amount: amount,
        account: account || null,
        method: method,
        email: email || null,
        requestDate: now
      };

      // أضف تفاصيل البنك فقط إذا كانت طريقة الدفع تحويل بنكي
      if (method && method.toLowerCase().includes("bank transfers")) {
        payload.bankNameHolder = bankNameHolder || null;
        payload.bankIBAN = bankIBAN || null;
        payload.bankName = bankName || null;
        payload.bankSwift = bankSwift || null;
      }

      // push لإنشاء مفتاح فريد ثم set
      const newRef = _push(_ref(dbInstance, "referrals/" + adminUid + "/withdraw"));
      await _set(newRef, payload);

      console.log("تم الإرسال بنجاح، المفتاح:", newRef.key || newRef.toString(), "payload:", payload);
      // بعد نجاح الإرسال: عيّن with = 'true' في localStorage
      try {
        localStorage.setItem('with', 'true');
        console.log("localStorage.with set to 'true'");
      } catch (err) {
        console.warn("تعذّر تعيين localStorage.with:", err);
      }

      alert("✅ تم إرسال بيانات السحب بنجاح إلى Realtime Database");

    } catch (e) {
      console.error("فشل الإرسال:", e);
      alert("❌ فشل إرسال البيانات! انظر Console للتفاصيل.");
    } finally {
      hideLoading();
      window.removeEventListener('beforeunload', beforeUnloadHandler);
    }
  });
})();
                                       </script>
<script>
    
          //كود جلب القيم المحفوضة للسحب
  window.onload = function () {
  const amount        = localStorage.getItem("withdrawAmount");
  const account       = localStorage.getItem("withdrawAccount");
  const method        = localStorage.getItem("withdrawMethod");
  const email         = localStorage.getItem("withdrawEmail");      // ← استخراج البريد
  const bankNameHolder= localStorage.getItem("bankNameHolder");
  const bankIBAN      = localStorage.getItem("bankIBAN");
  const bankName      = localStorage.getItem("bankName");
  const bankSwift     = localStorage.getItem("bankSwift");
  const now     =localStorage.getItem("requestDate");
  const transactionId     =localStorage.getItem("transactionId");
  // عرض القيم في العناصر
  document.getElementById("amountText").textContent = amount || "لاتوجد بيانات ";
  document.getElementById("accountText").textContent = account || "غير مستخدم في التحويل البنكي";
  document.getElementById("methodText").textContent = method || "لاتوجد بيانات";
  document.getElementById("withdrawEmail").textContent = email ||  "لاتوجد بيانات"
  document.getElementById("requestDate").textContent = now || "لاتوجد بيانات";
document.getElementById("transactionId").textContent = transactionId || "لاتوجد بيانات";

  // إذا كانت طريقة الدفع تحويل بنكي، أضف تفاصيل البنك
  if (method && method.toLowerCase().includes("bank transfers")) {
    document.getElementById("bankDetails").innerHTML = `
      <p><strong>Bank account name:</strong> ${bankNameHolder}</p>
      <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
      <p><strong>IBAN:</strong> ${bankIBAN}</p>
      <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
      <p><strong>Bank name:</strong> ${bankName}</p>
      <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
      <p><strong>SWIFT:</strong> ${bankSwift}</p>
      <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.2);background-color:black;">
    `;
  }
};
  
</script>
<script>
     // اذا تم السحب
firebase.auth().onAuthStateChanged(user => {
    if (!user) return;
    const uid = user.uid;

    firebase.database()
    .ref(`users/${uid}/withdraw`)
    .once('value')
    .then(snapshot => {
        const withdrawValue = snapshot.val();

        if (withdrawValue === 1) {
            // ✅ تغيير النصوص
            const el1 = document.getElementById("1");
            const el2 = document.getElementById("2");
            const el3 = document.getElementById("3");

            if (el1) el1.textContent = "تم ارسال مبلغ السحب من خادم SwapIO بنجاح";
            if (el2) {
                el2.textContent = "تم السحب";
                el2.style.color = "green";
            }
            if (el3) el3.style.display = "none";
        }
    })
    .catch(err => {
        console.error("خطأ في جلب قيمة withdraw:", err);
    });
});
</script>



</body>
</html>
